import { cacheStorage } from './../../../_cache/cacheStorage';
import { ListenChangeRedmineService } from './../../../_services/manager/user/listen-change-redmine.service';
import { HttpErrorResponse } from '@angular/common/http';
import { SpringSocketService } from './../../../_services/socket/spring-socket.service';
import { Component, OnInit, Input } from '@angular/core';
import { NotifyContent } from '../../../_models/user/notify-content';

@Component({
  selector: 'app-socket-notify',
  templateUrl: './socket-notify.component.html',
  styleUrls: ['./socket-notify.component.css']
})
export class SocketNotifyComponent implements OnInit {
  @Input() isShowInfomation: boolean;
  @Input() isShowNotify: boolean;
  messenger: any[] = [];
  userOnline: any;
  model: any = { user: '', messenger: '' };
  expires = new Date();
  constructor(private springSocketService: SpringSocketService) {
    this.springSocketService.getAllUser().subscribe((userOnline: any) => {
      // console.log(res);
      this.userOnline = JSON.parse(userOnline);
    }, (err: HttpErrorResponse) => {
      console.log(err);
    });
    this.springSocketService.getAllMessenger().subscribe((res: any) => {
      if (res.recipient === this.springSocketService.whoami) {
        const notifyConten: NotifyContent = res.message;
        console.log(res);
        const date = new Date(notifyConten.dataTo);
        if (date.getTime() > this.expires.getTime() + cacheStorage.cache.time) {
          notifyConten.dataTo = date;
          this.messenger.push(notifyConten);
          this.expires = date;
        }
      }
    });
  }
  sendMessenger() {
    this.springSocketService.sendMessageTo(this.model.user, this.model.messenger);
  }

  ngOnInit() {

  }

}
